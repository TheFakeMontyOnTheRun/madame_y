#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>




void shutdown();
void graphicsPut( int x, int y );
void clear();
uint8_t getKey();
void init();
void graphicsFlush();
void fix_line (int16_t x0, int16_t y0, int16_t x1, int16_t y1);
  
struct Projection {
  uint8_t px;
  uint8_t py;
  int16_t dx;
  int16_t dy;
};

const struct Projection projections[21] =
  {
    //                                   Z
    {0,	       128,	-1020,	512}, // 0
    {0,	       128,	-1020,	512}, // 1
    {64,	96,	-508,	256}, // 2
    {85,	85,	-340,	168}, // 3
    {96,	80,	-252,	128}, // 4
    {102,	77,	-204,	104}, // 5
    {106,	75,	-172,	88},  // 6
    {109,	73,	-148,	72},  // 7
    {112,	72,	-124,	64},  // 8
    {113,	71,	-116,	56},  // 9
    {115,	70,	-100,	48},  // 10
    {116,	70,	-92,	48},  // 11
    {117,	69,	-84,	40}, // 12
    {118,	69,	-76,	40}, // 13
    {118,	69,	-76,	40}, // 14
    {119,	68,	-68,	32}, // 15
    {120,	68,	-60,	32}, // 16
    {120,	68,	-60,	32}, // 17
    {120,	68,	-60,	32}, // 18
    {121,	67,	-52,	24}, // 19
    {121,	67,	-52,	24} // 20
  };

const int8_t map[32][32] = {
  {0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0},
  {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0}	  
};

int max( int x1, int x2 ) {
  return x1 > x2 ? x1 : x2;
}

int min( int x1, int x2 ) {
  return x1 < x2 ? x1 : x2;
}



void drawQuad( uint8_t x, uint8_t y, uint8_t x1, uint8_t y1 ) {

  uint8_t Y0 = min( y, y1 );
  uint8_t Y1 = max( y, y1 );
  
  /*  
  for ( int _y = Y0; _y < Y1; ++_y ) {
    
  }
  */

  fix_line( x, y, x1, y);
  fix_line( x, y1, x1, y1);
  fix_line( x, y, x, y1);
  fix_line( x1, y, x1, y1);
}





void drawCubeAt( int8_t x0, int8_t y0, int8_t z0, int8_t dX, int8_t dY, int8_t dZ ) {
  int8_t z1 = z0 + dZ;
  uint8_t z0px = (projections[ z0 ].px);
  uint8_t z0py = (projections[ z0 ].py);
  uint8_t z1px = (projections[ z1 ].px);
  uint8_t z1py = (projections[ z1 ].py);  
  int16_t z0dx = (projections[ z0 ].dx >> 3);
  int16_t z0dy = (projections[ z0 ].dy >> 2);
  int16_t z1dx = (projections[ z1 ].dx >> 3);
  int16_t z1dy = (projections[ z1 ].dy >> 2);

  
  uint8_t px0z0 = z0px - ( (x0) * z0dx);
  uint8_t py0z0 = z0py - ( (y0) * z0dy);

  uint8_t px1z0 = px0z0 - ( dX * z0dx);
  uint8_t py1z0 = py0z0 - ( dY * z0dy);
  
  uint8_t px0z1 = z1px - ( (x0) * z1dx);
  uint8_t py0z1 = z1py - ( (y0) * z1dy);
  
  uint8_t px1z1 = px0z1 - (dX * z1dx);
  uint8_t py1z1 = py0z1 - (dY * z1dy);







  drawQuad( px0z1, py0z1, px1z1, py1z1 );

  fix_line(px0z0, py0z0, px0z1, py0z1);
  fix_line(px1z0, py0z0, px1z1, py0z1);
  fix_line(px0z0, py1z0, px0z1, py1z1);
  fix_line(px1z0, py1z0, px1z1, py1z1);

  drawQuad( px0z0, py0z0, px1z0, py1z0 );
}


void dot( int8_t x0, int8_t y0, int8_t z0 ) {

  uint8_t z0px = (projections[ z0 ].px);
  uint8_t z0py = (projections[ z0 ].py);
  int16_t z0dx = (projections[ z0 ].dx >> 4);
  int16_t z0dy = (projections[ z0 ].dy >> 3);

  
  uint8_t px0z0 = z0px - ( 3 * (x0 + 1) * z0dx);
  uint8_t py0z0 = z0py - ( 3 * (y0 + 1) * z0dy);

  
  if (px0z0 < 255 && px0z0 > 0 && py0z0 < 127 ) {
    fix_line(px0z0, py0z0, px0z0, py0z0);
  }
}

const int val = 5;

int main(int argc, char** argv)
{

  int8_t x, y = 0;
  int8_t cameraX = 5;
  int8_t cameraZ = 5;

  init();

  if (val!=5) {
    fix_line( 2, 2, 100, 100 );
    while(1);
  }

  
  do {


  waitkey: 
    switch(getKey()) {
    case 'a':
      cameraX--;
      break;
    case 'd':
      cameraX++;
      break;	    
    case 's':
      cameraZ++;
      break;
    case 'w':
      cameraZ--;
      break;
    default:
      goto waitkey;
    }
    
    clear();
    
    
    fix_line( 0, 64, 255, 64);
    
    for ( int y = max( cameraZ - 20, 0); y <  min( cameraZ, 32) ; ++y ) {
      for (int x = max( cameraX - 10, 0); x < min( cameraX + 10, 32); ++x ) {
	int height = map[y][x];
	if ( height != 0 ) {
	  graphicsPut(x, y);
	  drawCubeAt( x - cameraX, -1, cameraZ - y, 1, height, 1);
	}
      }
    }
    
    
    
    graphicsPut(cameraX, cameraZ);
    
    
    fix_line( 0, 0, 255, 0);
    fix_line( 0, 128, 255, 128);
    fix_line( 255, 0, 255, 128);
    fix_line( 0, 0, 0, 128);
    
    
    
    
    graphicsFlush();
  } while(1);
  
  shutdown();
}
